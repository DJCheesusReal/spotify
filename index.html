<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Spotify PKCE Access Token Helper</title>
<style>
  body {
    background: #121212;
    color: #fff;
    font-family: 'Inter', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0; padding: 20px;
  }
  .container {
    background: #1e1e1e;
    padding: 30px;
    border-radius: 12px;
    max-width: 480px;
    width: 100%;
    text-align: center;
  }
  button {
    background: #1DB954;
    border: none;
    border-radius: 50px;
    padding: 15px 40px;
    font-weight: 700;
    color: white;
    cursor: pointer;
    font-size: 1rem;
    margin-top: 20px;
  }
  pre {
    background: #282828;
    padding: 15px;
    border-radius: 8px;
    overflow-x: auto;
    font-family: monospace;
    white-space: pre-wrap;
    word-wrap: break-word;
    margin-top: 20px;
  }
  #copy-message {
    margin-top: 10px;
    height: 24px;
    color: #1DB954;
    font-weight: bold;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Spotify PKCE Token Helper</h1>
  <div id="login-area">
    <p>Click to log in with Spotify and get your access token.</p>
    <button id="login-btn">Login with Spotify</button>
  </div>
  <div id="token-area" style="display:none;">
    <h2>Access Token</h2>
    <pre id="token-box"></pre>
    <button id="copy-btn">Copy Token</button>
    <div id="copy-message"></div>
  </div>
</div>

<script>
  const CLIENT_ID = 'a17cdd6ee24144f99cded06e508383ca'; // Your Spotify app client ID
  const REDIRECT_URI = 'https://spotify.djcheesus.com';  // Your registered redirect URI
  const SCOPE = 'user-read-playback-state user-read-currently-playing';

  const loginBtn = document.getElementById('login-btn');
  const tokenArea = document.getElementById('token-area');
  const loginArea = document.getElementById('login-area');
  const tokenBox = document.getElementById('token-box');
  const copyBtn = document.getElementById('copy-btn');
  const copyMessage = document.getElementById('copy-message');

  // Utility functions for PKCE
  async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    return new Uint8Array(hashBuffer);
  }

  function base64urlEncode(buffer) {
    return btoa(String.fromCharCode(...buffer))
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '');
  }

  // Generate code verifier: random string 43-128 chars
  function generateCodeVerifier() {
    const array = new Uint8Array(64);
    crypto.getRandomValues(array);
    return base64urlEncode(array);
  }

  // Generate code challenge from verifier
  async function generateCodeChallenge(verifier) {
    const hashed = await sha256(verifier);
    return base64urlEncode(hashed);
  }

  // Redirect user to Spotify login page with PKCE
  async function redirectToSpotify() {
    const verifier = generateCodeVerifier();
    sessionStorage.setItem('code_verifier', verifier);

    const challenge = await generateCodeChallenge(verifier);

    const authUrl = new URL('https://accounts.spotify.com/authorize');
    authUrl.searchParams.set('client_id', CLIENT_ID);
    authUrl.searchParams.set('response_type', 'code');
    authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
    authUrl.searchParams.set('scope', SCOPE);
    authUrl.searchParams.set('code_challenge_method', 'S256');
    authUrl.searchParams.set('code_challenge', challenge);

    window.location = authUrl.toString();
  }

  // Parse query params from URL
  function getQueryParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      code: params.get('code'),
      error: params.get('error')
    };
  }

  // Exchange code for access token using Spotify token endpoint
  async function fetchAccessToken(code, verifier) {
    const body = new URLSearchParams({
      client_id: CLIENT_ID,
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    });

    const response = await fetch('https://accounts.spotify.com/api/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body.toString()
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to fetch access token');
    }

    return response.json(); // { access_token, token_type, expires_in, refresh_token, scope }
  }

  // Copy to clipboard helper with feedback
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      copyMessage.textContent = '✅ Copied to clipboard!';
      setTimeout(() => (copyMessage.textContent = ''), 3000);
    }).catch(() => {
      copyMessage.textContent = '⚠️ Failed to copy automatically.';
    });
  }

  // Main page logic on load
  window.addEventListener('load', async () => {
    const { code, error } = getQueryParams();

    if (error) {
      alert('Error during Spotify login: ' + error);
      return;
    }

    if (code) {
      // Hide login, show token area
      loginArea.style.display = 'none';
      tokenArea.style.display = 'block';

      const verifier = sessionStorage.getItem('code_verifier');
      if (!verifier) {
        tokenBox.textContent = 'Error: Missing code verifier.';
        return;
      }

      try {
        const tokenResponse = await fetchAccessToken(code, verifier);

        tokenBox.textContent = JSON.stringify(tokenResponse, null, 2);
        copyToClipboard(tokenResponse.access_token);

        // Remove code and verifier from URL and storage for cleanliness
        history.replaceState(null, '', REDIRECT_URI);
        sessionStorage.removeItem('code_verifier');
      } catch (err) {
        tokenBox.textContent = 'Error fetching access token: ' + err.message;
      }
    }
  });

  loginBtn.addEventListener('click', () => {
    redirectToSpotify();
  });

  copyBtn.addEventListener('click', () => {
    copyToClipboard(tokenBox.textContent);
  });
</script>

</body>
</html>
